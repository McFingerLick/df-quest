import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Search, Filter, Save, Download, Upload, Trash2, ChevronDown } from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';

const CategorySection = ({ category, items, color, search, filter, handleCurrentChange }) => {
  const [isOpen, setIsOpen] = useState(false);

  // Automatically open section if there are search matches
  useEffect(() => {
    const hasMatchingItems = items.some(item => 
      item.name.toLowerCase().includes(search.toLowerCase())
    );
    setIsOpen(hasMatchingItems || !search);
  }, [search, items]);

  const calculateProgress = (items) => {
    const total = items.reduce((acc, item) => acc + item.required, 0);
    const current = items.reduce((acc, item) => acc + Math.min(item.current, item.required), 0);
    return (current / total) * 100;
  };

  const progress = calculateProgress(items);
  const filteredItems = items.filter(item => {
    const matchesSearch = item.name.toLowerCase().includes(search.toLowerCase());
    const matchesFilter = 
      filter === 'all' || 
      (filter === 'completed' && item.completed) || 
      (filter === 'incomplete' && !item.completed);
    return matchesSearch && matchesFilter;
  });

  return (
    <Card className={`mb-6 ${color} ${filteredItems.length === 0 && search ? 'hidden' : ''}`}>
      <CardHeader 
        className="flex flex-row items-center justify-between hover:bg-black/5 cursor-pointer"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center">
          <ChevronDown 
            className={`h-4 w-4 mr-2 transition-transform duration-200 ${
              isOpen ? '' : '-rotate-90'
            }`} 
          />
          <CardTitle className="capitalize">{category} Items</CardTitle>
        </div>
        <div className="text-sm text-gray-500">
          Progress: {Math.round(progress)}%
        </div>
      </CardHeader>
      
      {isOpen && (
        <CardContent>
          <Progress value={progress} className="mb-4" />
          <div className="space-y-4">
            {filteredItems.map((item, index) => (
              <div 
                key={item.name} 
                className={`flex items-center space-x-4 p-2 rounded-lg ${
                  item.completed ? 'bg-green-50' : ''
                }`}
              >
                <div className="flex-1">
                  <div className="font-medium">{item.name}</div>
                  <div className="text-sm text-gray-500">
                    Required: {item.required}
                  </div>
                </div>
                <Input
                  type="number"
                  value={item.current || ''}
                  onChange={(e) => handleCurrentChange(category, index, e.target.value)}
                  className="w-20"
                  min="0"
                  max={item.required}
                  placeholder="0"
                />
                <div 
                  className={`w-20 text-center ${
                    item.current >= item.required ? 'text-green-600' : 'text-gray-500'
                  }`}
                >
                  {item.current}/{item.required}
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      )}
    </Card>
  );
};

const InventoryTracker = () => {
  const initialInventory = {
    common: [
      { name: 'Lithium Battery', required: 3 },
      { name: 'LED Light', required: 2 },
      { name: 'Printed Circuit Board', required: 3 },
    ],
    blue: [
      { name: 'Bucket of Paint', required: 5 },
      { name: 'Basic Ammo Production Part', required: 3 },
      { name: 'Intel Recorder', required: 1 },
      { name: 'Socket Adapter', required: 3 },
      { name: 'Military Power Bank', required: 3 },
      { name: 'Medical Alcohol', required: 3 },
      { name: 'Forehead Thermometer', required: 3 },
      { name: 'Gunpowder', required: 3 },
    ],
    purple: [
      { name: 'HiFi Sound Card', required: 3 },
      { name: 'Data Military Intel', required: 3 },
      { name: 'ASUS Motherboard', required: 3 },
      { name: 'Radio', required: 3 },
      { name: 'SSD', required: 6 },
      { name: 'RAM', required: 6 },
      { name: 'Ahsarah Specialty Flask', required: 1 },
      { name: 'Antler Wall Decoration', required: 2 },
      { name: 'Sarah Guard Confidential Files', required: 4 },
      { name: 'Blood Pressure Meter', required: 2 },
      { name: 'Ahsarah Glamour Hookah', required: 2 },
    ],
    gold: [
      { name: "Saeed's Pocket Watch", required: 1 },
      { name: 'Coffee', required: 2 },
      { name: 'SLR Camera', required: 2 },
      { name: 'Graphics Card', required: 1 },
      { name: 'Olivia Champagne', required: 1 },
      { name: 'Cell Phone', required: 2 },
      { name: 'CPU', required: 6 },
      { name: 'Merit Medal', required: 4 },
      { name: 'Ahsarah Specialty Wine Glass', required: 1 },
      { name: 'Shiny Pirate Gold Coin', required: 1 },
      { name: 'Military Explosive', required: 1 },
      { name: 'Pure Gold Lighter', required: 4 },
    ],
  };

  const [inventory, setInventory] = useState(() => {
    const stored = localStorage.getItem('inventory');
    if (stored) {
      return JSON.parse(stored);
    }
    return Object.keys(initialInventory).reduce((acc, category) => {
      acc[category] = initialInventory[category].map(item => ({
        ...item,
        current: 0,
        completed: false,
      }));
      return acc;
    }, {});
  });

  const [search, setSearch] = useState('');
  const [filter, setFilter] = useState('all');
  const [showSaveAlert, setShowSaveAlert] = useState(false);

  const handleCurrentChange = (category, index, value) => {
    const newInventory = { ...inventory };
    const required = newInventory[category][index].required;
    newInventory[category][index].current = Math.min(required, Math.max(0, parseInt(value) || 0));
    newInventory[category][index].completed = 
      newInventory[category][index].current >= required;
    saveToLocalStorage(newInventory);
    setInventory(newInventory);
  };

  const saveToLocalStorage = (data) => {
    localStorage.setItem('inventory', JSON.stringify(data));
    setShowSaveAlert(true);
    setTimeout(() => setShowSaveAlert(false), 2000);
  };

  const resetProgress = () => {
    if (window.confirm('Are you sure you want to reset all progress?')) {
      const resetData = Object.keys(inventory).reduce((acc, category) => {
        acc[category] = inventory[category].map(item => ({
          ...item,
          current: 0,
          completed: false,
        }));
        return acc;
      }, {});
      saveToLocalStorage(resetData);
      setInventory(resetData);
    }
  };

  const exportProgress = () => {
    // Only export the current state of items (count and completion)
    const saveData = Object.entries(inventory).reduce((acc, [category, items]) => {
      acc[category] = items.map(item => ({
        name: item.name,
        current: item.current,
        completed: item.completed
      }));
      return acc;
    }, {});

    const dataStr = JSON.stringify(saveData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    const date = new Date().toISOString().split('T')[0];
    link.download = `zerohour-save-${date}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const importProgress = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const saveData = JSON.parse(e.target.result);
          const newInventory = { ...inventory };
          
          // Update existing inventory with saved data
          Object.entries(saveData).forEach(([category, items]) => {
            if (newInventory[category]) {
              items.forEach(savedItem => {
                const itemIndex = newInventory[category].findIndex(
                  item => item.name === savedItem.name
                );
                if (itemIndex !== -1) {
                  newInventory[category][itemIndex].current = savedItem.current;
                  newInventory[category][itemIndex].completed = savedItem.completed;
                }
              });
            }
          });

          saveToLocalStorage(newInventory);
          setInventory(newInventory);
          setShowSaveAlert(true);
          event.target.value = '';
        } catch (error) {
          alert('Error loading save file. Please make sure it\'s a valid Zero Hour save file.');
          console.error('Import error:', error);
        }
      };
      reader.readAsText(file);
    }
  };

  const getCategoryColor = (category) => {
    switch(category) {
      case 'common': return 'bg-green-200';
      case 'blue': return 'bg-sky-200';
      case 'purple': return 'bg-purple-200';
      case 'gold': return 'bg-yellow-200';
      default: return 'bg-gray-100';
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="flex flex-col space-y-4 mb-6">
        <h1 className="text-3xl font-bold">Zero Hour Inventory Tracker</h1>
        
        <div className="flex space-x-4">
          <div className="relative flex-1">
            <Search className="absolute left-2 top-2.5 h-4 w-4 text-gray-500" />
            <Input
              placeholder="Search items..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-8"
            />
          </div>
          
          <select
            value={filter}
            onChange={(e) => setFilter(e.target.value)}
            className="px-4 py-2 border rounded-md"
          >
            <option value="all">All Items</option>
            <option value="completed">Completed</option>
            <option value="incomplete">Incomplete</option>
          </select>

          <Button variant="outline" onClick={exportProgress}>
            <Download className="h-4 w-4 mr-2" />
            Export Save
          </Button>

          <div className="relative">
            <input
              type="file"
              accept=".json"
              onChange={importProgress}
              className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
              title="Import save file"
            />
            <Button variant="outline">
              <Upload className="h-4 w-4 mr-2" />
              Import Save
            </Button>
          </div>

          <Button variant="destructive" onClick={resetProgress}>
            <Trash2 className="h-4 w-4 mr-2" />
            Reset
          </Button>
        </div>
      </div>

      {showSaveAlert && (
        <Alert className="mb-4">
          <Save className="h-4 w-4" />
          <AlertDescription>Progress saved successfully!</AlertDescription>
        </Alert>
      )}

      {Object.entries(inventory).map(([category, items]) => (
        <CategorySection
          key={category}
          category={category}
          items={items}
          color={getCategoryColor(category)}
          search={search}
          filter={filter}
          handleCurrentChange={handleCurrentChange}
        />
      ))}
    </div>
  );
};

export default InventoryTracker;
